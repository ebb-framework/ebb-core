debug: true
pipeline:
  run_node_build:
    image: node:${NODE_VERSION}
    environment:
      - NPM_CONFIG_LOGLEVEL=silent
    commands:
      - npm install
      - npm test

  run_flow_checks:
    image: netproteus/flowtype:0.30.0
    commands:
      - flow version
      - flow check
    when:
      matrix:
        NODE_VERSION: 6


  apply_npm_version:
    image: node:${NODE_VERSION}
    commands:
      - git config --global user.name "Drone CI"
      - git config --global user.email "drone@eventualconsistency.net"
      - npm version ${DRONE_TAG} || true
    when:
      event: tag

  publish_coverage:
    image: plugins/coverage
    pattern: coverage/lcov.info
    when:
      matrix:
        NODE_VERSION: 6

  deploy_npm_package:
    image: plugins/npm
    when:
      event: tag
      matrix:
        NODE_VERSION: 6

matrix:
  NODE_VERSION:
    - 6
    - 5
    - 4